import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { ArrowLeft, Save, UserPlus, Building2, AlertCircle, CheckCircle } from 'lucide-react';
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { getCustomerService } from '@/services';
import { CustomerRequest, CustomerRequestSchema } from '@/Schema/customer.schema';
import { ZodError } from 'zod';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { toast } from 'sonner';

// Form state interface - extends CustomerRequest with string values for form inputs
interface CreateCustomerForm {
  name: string;
  companyName: string;
  representativeName: string;
  taxCode: string;
  phone: string;
  address: string;
  type: string;
  maxDebt: string;
  currentDebt: string;
}

export default function CreateCustomer() {
  const navigate = useNavigate();
  const [form, setForm] = useState<CreateCustomerForm>({
    name: '',
    companyName: '',
    representativeName: '',
    taxCode: '',
    phone: '',
    address: '',
    type: 'company', // M·∫∑c ƒë·ªãnh l√† c√¥ng ty
    maxDebt: '20000000', // M·∫∑c ƒë·ªãnh 20 tri·ªáu
    currentDebt: '0', // M·∫∑c ƒë·ªãnh 0
  });
  const [errors, setErrors] = useState<Partial<CreateCustomerForm>>({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitSuccess, setSubmitSuccess] = useState(false);
  const [generatedCode, setGeneratedCode] = useState('');

  // T·∫°o t√™n vi·∫øt t·∫Øt t·ª´ h·ªç t√™n ng∆∞·ªùi ƒë·∫°i di·ªán (ch·ªâ l·∫•y 2 t·ª´ cu·ªëi)
  const generateShortName = (fullName: string): string => {
    if (!fullName.trim()) return '';
    
    const words = fullName.trim().split(' ').filter(word => word.length > 0);
    
    // L·∫•y t·ªëi ƒëa 2 t·ª´ cu·ªëi c√πng
    const lastTwoWords = words.slice(-2);
    
    return lastTwoWords
      .map(word => word.charAt(0).toUpperCase())
      .join('');
  };

  // T·∫°o m√£ kh√°ch h√†ng preview (simplified version - real generation happens on server)
  const generatePreviewCode = (representativeName: string): string => {
    if (!representativeName.trim()) return '';
    
    const shortName = generateShortName(representativeName);
    
    // For preview purposes, use a placeholder number
    // The actual customer code will be generated by the server
    return `XXXX${shortName}`;
  };

  const handleInputChange = (field: keyof CreateCustomerForm, value: string) => {
    setForm(prev => ({
      ...prev,
      [field]: value
    }));
    
    // C·∫≠p nh·∫≠t preview m√£ kh√°ch h√†ng khi thay ƒë·ªïi t√™n ng∆∞·ªùi ƒë·∫°i di·ªán
    if (field === 'representativeName') {
      setGeneratedCode(generatePreviewCode(value));
    }
    
    // Clear error when user starts typing
    if (errors[field]) {
      setErrors(prev => ({
        ...prev,
        [field]: undefined
      }));
    }
  };

  const validateForm = (): boolean => {
    try {
      // Prepare data for validation
      const customerData: CustomerRequest = {
        name: form.name || form.representativeName, // Use representative name if no name provided
        companyName: form.companyName || undefined,
        representativeName: form.representativeName,
        phone: form.phone,
        taxCode: form.taxCode || undefined,
        address: form.address,
        type: form.type,
        currentDebt: parseInt(form.currentDebt) || 0,
        maxDebt: parseInt(form.maxDebt) || 0,
      };

      // Validate using Zod schema
      CustomerRequestSchema.parse(customerData);
      
      // Clear errors if validation passes
      setErrors({});
      return true;
      
    } catch (error) {
      // Handle Zod validation errors
      const newErrors: Partial<CreateCustomerForm> = {};
      
      if (error instanceof ZodError) {
        error.errors.forEach((err) => {
          const fieldPath = err.path[0];
          if (fieldPath === 'name' || fieldPath === 'representativeName') {
            newErrors.representativeName = 'T√™n ng∆∞·ªùi ƒë·∫°i di·ªán l√† b·∫Øt bu·ªôc';
          } else if (fieldPath === 'phone') {
            newErrors.phone = 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá';
          } else if (fieldPath === 'address') {
            newErrors.address = 'ƒê·ªãa ch·ªâ l√† b·∫Øt bu·ªôc';
          } else if (fieldPath === 'taxCode') {
            newErrors.taxCode = 'M√£ s·ªë thu·∫ø kh√¥ng h·ª£p l·ªá';
          } else if (fieldPath === 'maxDebt') {
            newErrors.maxDebt = 'H·∫°n m·ª©c c√¥ng n·ª£ kh√¥ng h·ª£p l·ªá';
          } else if (fieldPath === 'currentDebt') {
            newErrors.currentDebt = 'C√¥ng n·ª£ hi·ªán t·∫°i kh√¥ng h·ª£p l·ªá';
          }
        });
      }
      
      setErrors(newErrors);
      return false;
    }
  };

  const generateCustomerCode = () => {
    if (!form.representativeName.trim()) {
      alert('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi ƒë·∫°i di·ªán tr∆∞·ªõc');
      return;
    }
    
    const previewCode = generatePreviewCode(form.representativeName);
    setGeneratedCode(previewCode);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!validateForm()) {
      return;
    }

    setIsSubmitting(true);
    
    try {
      // Prepare customer data according to API schema
      const customerData: CustomerRequest = {
        name: form.name || form.representativeName, // Use representative name if no name provided
        companyName: form.companyName,
        representativeName: form.representativeName,
        phone: form.phone,
        taxCode: form.taxCode,
        address: form.address,
        type: form.type,
        currentDebt: parseInt(form.currentDebt) || 0,
        maxDebt: parseInt(form.maxDebt) || 0,
      };

      console.log('üöÄ Creating customer with data:', customerData);

      // Call API through CustomerService
      const customerService = getCustomerService();
      const response = await customerService.createCustomer(customerData);

      if (response.success && response.data) {
        console.log('‚úÖ Customer created successfully:', response.data);
        toast.success('Kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!');
        
        setSubmitSuccess(true);
        
        // Redirect sau 2 gi√¢y
        setTimeout(() => {
          navigate('/customers');
        }, 2000);
      } else {
        throw new Error(response.message || 'Kh√¥ng th·ªÉ t·∫°o kh√°ch h√†ng');
      }
      
    } catch (error) {
      console.error('‚ùå Error creating customer:', error);
      toast.error(error instanceof Error ? error.message : 'L·ªói kh√¥ng x√°c ƒë·ªãnh khi t·∫°o kh√°ch h√†ng');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleCancel = () => {
    navigate('/customers');
  };

  if (submitSuccess) {
    return (
      <div className="space-y-6">
        <div className="flex items-center gap-3">
          <Button variant="ghost" onClick={() => navigate('/customers')} className="gap-2">
            <ArrowLeft className="h-4 w-4" />
            Quay l·∫°i
          </Button>
        </div>
        
        <Card>
          <CardContent className="text-center py-8">
            <CheckCircle className="h-16 w-16 text-green-500 mx-auto mb-4" />
            <h3 className="text-lg font-semibold mb-2">T·∫°o kh√°ch h√†ng th√†nh c√¥ng!</h3>
            <p className="text-muted-foreground mb-4">
              Kh√°ch h√†ng <strong>{form.representativeName}</strong> ƒë√£ ƒë∆∞·ª£c t·∫°o v·ªõi m√£ <strong>{generatedCode || generatePreviewCode(form.representativeName)}</strong>
            </p>
            <p className="text-sm text-muted-foreground">ƒêang chuy·ªÉn v·ªÅ danh s√°ch kh√°ch h√†ng...</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center gap-3">
        <Button variant="ghost" onClick={handleCancel} className="gap-2">
          <ArrowLeft className="h-4 w-4" />
          Quay l·∫°i
        </Button>
        <div>
          <h1 className="text-3xl font-bold text-foreground">Th√™m kh√°ch h√†ng m·ªõi</h1>
          <p className="text-muted-foreground mt-1">Nh·∫≠p th√¥ng tin kh√°ch h√†ng</p>
        </div>
      </div>

      <form onSubmit={handleSubmit} className="space-y-6">
        <div className="grid gap-6 lg:grid-cols-3">
          {/* Main Form */}
          <div className="lg:col-span-2">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <UserPlus className="h-5 w-5" />
                  Th√¥ng tin c∆° b·∫£n
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-4">
                  <div className="space-y-2">
                    <Label htmlFor="name">
                      T√™n kh√°ch h√†ng <span className="text-red-500">*</span>
                    </Label>
                    <Input
                      id="name"
                      value={form.name}
                      onChange={(e) => handleInputChange('name', e.target.value)}
                      placeholder="VD: Nguy·ªÖn Minh Ph√∫c (t√™n g·ªçi chung)"
                      className={errors.name ? 'border-red-500' : ''}
                    />
                    {errors.name && (
                      <p className="text-sm text-red-500">{errors.name}</p>
                    )}
                    <p className="text-xs text-muted-foreground">
                      T√™n g·ªçi chung c·ªßa kh√°ch h√†ng (c√≥ th·ªÉ gi·ªëng t√™n ƒë·∫°i di·ªán ho·∫∑c t√™n c√¥ng ty)
                    </p>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="representativeName">
                      T√™n ng∆∞·ªùi ƒë·∫°i di·ªán <span className="text-red-500">*</span>
                    </Label>
                    <div className="flex gap-2">
                      <Input
                        id="representativeName"
                        value={form.representativeName}
                        onChange={(e) => handleInputChange('representativeName', e.target.value)}
                        placeholder="VD: Nguy·ªÖn Minh Ph√∫c"
                        className={errors.representativeName ? 'border-red-500' : ''}
                      />
                      <Button 
                        type="button"
                        variant="outline" 
                        onClick={generateCustomerCode}
                        className="whitespace-nowrap"
                        disabled={!form.representativeName.trim()}
                      >
                        Preview
                      </Button>
                    </div>
                    {errors.representativeName && (
                      <p className="text-sm text-red-500">{errors.representativeName}</p>
                    )}
                    <p className="text-xs text-muted-foreground">
                      T√™n ng∆∞·ªùi ƒë·∫°i di·ªán s·∫Ω ƒë∆∞·ª£c d√πng ƒë·ªÉ t·∫°o m√£ kh√°ch h√†ng
                    </p>
                  </div>
                  
                  <div className="space-y-2">
                    <Label>M√£ kh√°ch h√†ng (t·ª± ƒë·ªông)</Label>
                    <div className="p-2 bg-muted rounded-md border">
                      <span className="font-mono text-sm">
                        {generatedCode || (form.representativeName ? generatePreviewCode(form.representativeName) : 'Nh·∫≠p t√™n ng∆∞·ªùi ƒë·∫°i di·ªán ƒë·ªÉ xem preview')}
                      </span>
                    </div>
                    <p className="text-xs text-muted-foreground">
                      M√£ kh√°ch h√†ng s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông t·∫°o b·ªüi h·ªá th·ªëng khi l∆∞u
                    </p>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="companyName">T√™n c√¥ng ty</Label>
                    <Input
                      id="companyName"
                      value={form.companyName}
                      onChange={(e) => handleInputChange('companyName', e.target.value)}
                      placeholder="VD: C√¥ng ty TNHH ABC (kh√¥ng b·∫Øt bu·ªôc)"
                      className={errors.companyName ? 'border-red-500' : ''}
                    />
                    {errors.companyName && (
                      <p className="text-sm text-red-500">{errors.companyName}</p>
                    )}
                    <p className="text-xs text-muted-foreground">
                      C√≥ th·ªÉ ƒë·ªÉ tr·ªëng n·∫øu l√† c√° nh√¢n ho·∫∑c doanh nghi·ªáp t∆∞ nh√¢n
                    </p>
                  </div>
                </div>

                <div className="grid gap-4 md:grid-cols-3">
                  <div className="space-y-2">
                    <Label htmlFor="type">
                      Lo·∫°i kh√°ch h√†ng <span className="text-red-500">*</span>
                    </Label>
                    <select
                      id="type"
                      value={form.type}
                      onChange={(e) => handleInputChange('type', e.target.value)}
                      className={`flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 ${errors.type ? 'border-red-500' : ''}`}
                    >
                      <option value="C√¥ng ty">C√¥ng ty</option>
                      <option value="C√° nh√¢n">C√° nh√¢n</option>
                      <option value="C∆° quan nh√† n∆∞·ªõc">C∆° quan nh√† n∆∞·ªõc</option>
                      <option value="T·ªï ch·ª©c phi l·ª£i nhu·∫≠n">T·ªï ch·ª©c phi l·ª£i nhu·∫≠n</option>
                    </select>
                    {errors.type && (
                      <p className="text-sm text-red-500">{errors.type}</p>
                    )}
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="taxCode">M√£ s·ªë thu·∫ø</Label>
                    <Input
                      id="taxCode"
                      value={form.taxCode}
                      onChange={(e) => handleInputChange('taxCode', e.target.value)}
                      placeholder="VD: 0123456789 (kh√¥ng b·∫Øt bu·ªôc)"
                      className={errors.taxCode ? 'border-red-500' : ''}
                    />
                    {errors.taxCode && (
                      <p className="text-sm text-red-500">{errors.taxCode}</p>
                    )}
                  </div>
                  
                  <div className="space-y-2">
                    <Label htmlFor="phone">
                      S·ªë ƒëi·ªán tho·∫°i <span className="text-red-500">*</span>
                    </Label>
                    <Input
                      id="phone"
                      value={form.phone}
                      onChange={(e) => handleInputChange('phone', e.target.value)}
                      placeholder="VD: 0901234567"
                      className={errors.phone ? 'border-red-500' : ''}
                    />
                    {errors.phone && (
                      <p className="text-sm text-red-500">{errors.phone}</p>
                    )}
                  </div>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="address">
                    ƒê·ªãa ch·ªâ <span className="text-red-500">*</span>
                  </Label>
                  <Textarea
                    id="address"
                    value={form.address}
                    onChange={(e) => handleInputChange('address', e.target.value)}
                    placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß"
                    rows={3}
                    className={errors.address ? 'border-red-500' : ''}
                  />
                  {errors.address && (
                    <p className="text-sm text-red-500">{errors.address}</p>
                  )}
                </div>
              </CardContent>
            </Card>

            {/* Th√¥ng tin c√¥ng n·ª£ */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <AlertCircle className="h-5 w-5" />
                  Th√¥ng tin c√¥ng n·ª£
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="maxDebt">
                      H·∫°n m·ª©c c√¥ng n·ª£ t·ªëi ƒëa (VNƒê) <span className="text-red-500">*</span>
                    </Label>
                    <Input
                      id="maxDebt"
                      type="number"
                      value={form.maxDebt}
                      onChange={(e) => handleInputChange('maxDebt', e.target.value)}
                      placeholder="20000000"
                      min="0"
                      step="1000000"
                      className={errors.maxDebt ? 'border-red-500' : ''}
                    />
                    {errors.maxDebt && (
                      <p className="text-sm text-red-500">{errors.maxDebt}</p>
                    )}
                    <p className="text-xs text-muted-foreground">
                      M·∫∑c ƒë·ªãnh: 20,000,000‚Ç´. C√≥ th·ªÉ ƒëi·ªÅu ch·ªânh theo quy m√¥ kh√°ch h√†ng.
                    </p>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="currentDebt">
                      C√¥ng n·ª£ hi·ªán t·∫°i (VNƒê)
                    </Label>
                    <Input
                      id="currentDebt"
                      type="number"
                      value={form.currentDebt}
                      onChange={(e) => handleInputChange('currentDebt', e.target.value)}
                      placeholder="0"
                      min="0"
                      step="100000"
                      className={errors.currentDebt ? 'border-red-500' : ''}
                    />
                    {errors.currentDebt && (
                      <p className="text-sm text-red-500">{errors.currentDebt}</p>
                    )}
                    <p className="text-xs text-muted-foreground">
                      Kh√°ch h√†ng m·ªõi th∆∞·ªùng b·∫Øt ƒë·∫ßu v·ªõi 0‚Ç´
                    </p>
                  </div>
                </div>

                <div className="p-3 bg-muted rounded-lg">
                  <p className="text-sm font-medium mb-2">Tr·∫°ng th√°i c√¥ng n·ª£ d·ª± ki·∫øn:</p>
                  <div className="flex items-center gap-2">
                    {(() => {
                      const maxDebt = parseInt(form.maxDebt) || 0;
                      const currentDebt = parseInt(form.currentDebt) || 0;
                      const ratio = maxDebt > 0 ? (currentDebt / maxDebt) * 100 : 0;
                      
                      let status: 'good' | 'warning' | 'blocked' = 'good';
                      let statusText = 'T·ªët';
                      let statusColor = 'bg-green-500';
                      
                      if (currentDebt > maxDebt) {
                        status = 'blocked';
                        statusText = 'B·ªã ch·∫∑n';
                        statusColor = 'bg-red-500';
                      } else if (ratio >= 80) {
                        status = 'warning';
                        statusText = 'C·∫£nh b√°o';
                        statusColor = 'bg-yellow-500';
                      }
                      
                      return (
                        <>
                          <div className={`w-3 h-3 rounded-full ${statusColor}`}></div>
                          <span className="text-sm">{statusText} ({Math.round(ratio)}%)</span>
                        </>
                      );
                    })()}
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>

          {/* Info & Actions */}
          <div className="space-y-6">
            <Alert>
              <AlertCircle className="h-4 w-4" />
              <AlertDescription className="text-sm">
                <strong>L∆∞u √Ω:</strong>
                <ul className="mt-2 space-y-1 list-disc list-inside">
                  <li>T√™n ng∆∞·ªùi ƒë·∫°i di·ªán l√† b·∫Øt bu·ªôc ƒë·ªÉ t·∫°o m√£ kh√°ch h√†ng</li>
                  <li>M√£ kh√°ch h√†ng t·ª± ƒë·ªông theo format: [STT 4 ch·ªØ s·ªë][T√™n vi·∫øt t·∫Øt]</li>
                  <li>T√™n vi·∫øt t·∫Øt l·∫•y 2 ch·ªØ c√°i ƒë·∫ßu c·ªßa 2 t·ª´ cu·ªëi (VD: Nguy·ªÖn Minh Ph√∫c ‚Üí MP)</li>
                  <li>T√™n c√¥ng ty kh√¥ng b·∫Øt bu·ªôc (c√° nh√¢n ho·∫∑c doanh nghi·ªáp t∆∞ nh√¢n)</li>
                  <li>S·ªë ƒëi·ªán tho·∫°i ph·∫£i ƒë√∫ng ƒë·ªãnh d·∫°ng Vi·ªát Nam</li>
                  <li>M√£ s·ªë thu·∫ø c√≥ 10 ch·ªØ s·ªë (kh√¥ng b·∫Øt bu·ªôc)</li>
                </ul>
              </AlertDescription>
            </Alert>

            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Building2 className="h-5 w-5" />
                  Preview
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <div>
                  <p className="text-sm text-muted-foreground">T√™n ng∆∞·ªùi ƒë·∫°i di·ªán</p>
                  <p className="font-medium">{form.representativeName || 'Ch∆∞a nh·∫≠p'}</p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">M√£ kh√°ch h√†ng (preview)</p>
                  <p className="font-medium font-mono">{generatedCode || (form.representativeName ? generatePreviewCode(form.representativeName) : 'Ch∆∞a c√≥')}</p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">T√™n c√¥ng ty</p>
                  <p className="font-medium">{form.companyName || 'Kh√¥ng c√≥ (c√° nh√¢n)'}</p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">S·ªë ƒëi·ªán tho·∫°i</p>
                  <p className="font-medium">{form.phone || 'Ch∆∞a nh·∫≠p'}</p>
                </div>
                {form.taxCode && (
                  <div>
                    <p className="text-sm text-muted-foreground">M√£ s·ªë thu·∫ø</p>
                    <p className="font-medium font-mono">{form.taxCode}</p>
                  </div>
                )}
              </CardContent>
            </Card>

            <div className="flex flex-col gap-2">
              <Button 
                type="submit" 
                disabled={isSubmitting}
                className="w-full gap-2"
              >
                <Save className="h-4 w-4" />
                {isSubmitting ? 'ƒêang t·∫°o...' : 'T·∫°o kh√°ch h√†ng'}
              </Button>
              <Button 
                type="button" 
                variant="outline" 
                onClick={handleCancel}
                disabled={isSubmitting}
                className="w-full"
              >
                H·ªßy b·ªè
              </Button>
            </div>
          </div>
        </div>
      </form>
    </div>
  );
}